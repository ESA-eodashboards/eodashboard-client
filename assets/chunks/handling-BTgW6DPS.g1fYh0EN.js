import{d as z,H as U,G as K,aV as v,aW as x,a as J,aX as A,aY as P,l as N,t as b,x as D,aZ as M,a_ as G,a$ as H,b0 as W,b1 as $,g as Y}from"./eo-dash.NWhyv4Md.js";import{u as X,g as T,e as Z,a as Q,s as L,c as j,p as ee,b as te,d as E,f as ne,h as re}from"./async-B2-WW9U7.UIaXi3m-.js";async function ae({links:t,jsonformValue:r,specUrl:a,customEndpointsHandler:e,jsonformSchema:n,selectedStac:o,isPolling:c,jobs:l,enableCompare:s=!1}){if(!a||!t)return[null,null];const u=await v.get(a).then(h=>h.data),i={},[d,f]=L(t,"service",void 0),p=e&&r&&await e({jsonformSchema:n,jsonformValue:r,links:f,selectedStac:o,isPolling:c,jobs:l,enableCompare:s});if(p&&p.length)return u.data.values=p,[u,i];const g=d.filter(h=>h.rel==="service");try{e:for(const h of g??[])switch(h.type){case void 0:continue;case"application/json":await oe(u,{url:h.href,jsonformValue:r,link:h,flatstyleUrl:h["eox:flatstyle"]});break e;case"text/csv":await se(u,{url:h.href,jsonformValue:r,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[u,i]}async function oe(t,{url:r,jsonformValue:a,link:e,flatstyleUrl:n}){if(t.data){if(e.method=="GET"){const o=await V(r,a,n);t.data.values=await v.get(o).then(c=>c.data)}else if(e.method=="POST"){if(!e.body)return console.error("[eodash] Inline data POST request requires a body template"),t;const o=await v.get(e.body,{responseType:"text"}).then(l=>l.data),c=JSON.parse(b.render(o,{...a??{}}));t.data.values=await v.post(r,c).then(l=>l.data)}return t}}async function se(t,{url:r,jsonformValue:a,flatstyleUrl:e}){if(!t.data)return;const n=await V(r,a,e);return t.data.url=n,t}async function V(t,r,a){let e={};return a&&(e=await v.get(a).then(n=>n.data)),b.render(t,{...r??{},...e})}async function ie({links:t,jsonformValue:r,layerId:a,projection:e}){if(!t)return;const[n,o]=L(t,"service","image/tiff");if(!n.length)return;let c=[],l="";for(const u of n??[])c.push(b.render(u.href,{...r??{}}));return await Promise.all(n.map(u=>j(u,a,c,e,l))).then(u=>u.filter(i=>!!i))}function ce(t,r,a){if(!t)return;const e=t.filter(o=>o.rel==="service"&&o.type==="image/png"),n=[];for(const o of e)n.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:a,url:b.render(o.href,{...r??{}})}});return n}async function le(t,r,a){if(!t)return;const e=[],n=t.filter(c=>c.rel==="service"&&c.type==="application/geo+json");if(!n.length)return e;let o=null;for(const c of n){"eox:flatstyle"in(c??{})&&(o=await v.get(c["eox:flatstyle"]).then(i=>i.data));let l,s;if(o){const i=M(a??"",o);l=i.layerConfig,s=i.style}const u={type:"Vector",source:{type:"Vector",url:b.render(c.href,{...r??{}}),format:"GeoJSON"},properties:{id:c.id+"_process",title:"Results "+a,...l&&{...l}},...s&&{style:s}};e.push(u)}return e}async function ue({links:t,jsonformValue:r,layerId:a,projection:e,origBbox:n,isPolling:o,selectedStac:c,jsonformSchema:l,jobs:s,customLayersHandler:u,enableCompare:i=!1}){if(!t)return[];const d=[],[f,p]=L(t,"service",void 0);if(u&&r&&c&&l&&p.length>0){const k=await u({jsonformValue:r,links:p,selectedStac:c,isPolling:o,jsonformSchema:l,jobs:s,enableCompare:i});k.length&&d.push(...k)}const g=await le(f,r,a),h=ce(f,r,n),m=await ie({links:f,jsonformValue:r,layerId:a,projection:e});return d.push(...g??[],...h??[],...m??[]),d}async function de(t,r,a=!1){const e=t.find(l=>l.rel==="service"&&l.type=="application/json; profile=collection"&&l.endpoint==="STAC");if(!e)return;let n=b.render(e.href,{...r??{}});D.value&&(D.value=!1);const o=J();await(a?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(n,!0)}async function fe({links:t,jsonformValue:r,isPolling:a,selectedStac:e,jobs:n,enableCompare:o=!1}){if(!a)return;const c=t.filter(s=>s.rel==="service"&&s.endpoint==="eoxhub_workspaces"),l=[];for(const s of c){const u=await v.get(s.body,{responseType:"text"}).then(f=>f.data),i=JSON.parse(b.render(u,{...r??{}})),d=o?P:x;try{const f=await v.post(s.href,i,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(d.value)||"[]");p.push(f.headers.location),localStorage.setItem(d.value,JSON.stringify(p));const g=await ee({jobs:n,processUrl:f.headers.location,isPolling:a,enableCompare:o}).then(h=>te(h)).catch(h=>(h instanceof Error?console.error("Polling failed:",h.message):console.error("Unknown error occurred during polling:",h),[]));await E(n,d.value),l.push(...await ne(g,s,e))}catch(f){await E(n,d.value),f instanceof Error?console.error("Error sending POST request:",f.message):console.error("Unknown error occurred:",f)}}return l}const he=pe([fe]);function pe(t){return async r=>await Promise.all(t.map(a=>a(r))).then(a=>{const e=[];for(const n of a)e.push(...(n==null?void 0:n.filter(ge))??[]);return e})}function ge(t){return!!t&&!!t.type&&(!!t.source||!!t.layers)}async function ve({links:t,jsonformValue:r,jsonformSchema:a,selectedStac:e,enableCompare:n=!1}){const o=t.find(g=>g.rel==="service"&&g.endpoint==="sentinelhub");if(!o)return;const c=await we(e,n?G.value:H.value);if(!c){console.error("[eodash] evalscript link for sentinel hub not found in indicator",c);return}if(!o)return;const l=o.href,s=T(a),u=r[s],f=await ye("414401d7-91f3-4a59-bbd4-117abf7f1bce","RaM>F4o,opW-i{4zV~I4]j|a13Y~@3,,+KdVUh3E");if(!f){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const p=re(e.extent.temporal.interval[0],[r.start_date,r.end_date],r.distribution);return await Promise.all(p.map(([g,h])=>me({url:l,bearer:f,bbox:u,from:h,to:g,exampleLink:c}).catch(m=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",m)))).then(g=>g.flat().map(h=>h.outputs.data))}async function ye(t,r){const a=sessionStorage.getItem("sentinelhub_token"),e=sessionStorage.getItem("sentinelhub_token_time"),n=Date.now()-Number(e)<3600*1e3;if(a&&n)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),a;const o=await be(t,r);if(o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",o),o}async function be(t,r){const a="https://services.sentinel-hub.com/oauth/token",e={"Content-Type":"application/x-www-form-urlencoded"},n=new URLSearchParams({client_id:t,client_secret:r,response_type:"token",grant_type:"client_credentials"});return await v.post(a,n,{headers:e}).then(o=>o.data.access_token)}async function me({url:t,bearer:r,bbox:a,from:e,to:n,timeout:o=2e4,exampleLink:c}){if(!c){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!a){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!e||!n||new Date(e)>new Date(n)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",e,n);return}const l=await v.get(c.href,{responseType:"text"}).then(i=>i.data);if(!l||l.error){console.error("[eodash] Error (sentinelhub): evalscript not found",l);return}const s={input:{bounds:{bbox:a},data:[{dataFilter:{},type:c.dataId}]},aggregation:{evalscript:l,timeRange:{from:e,to:n},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},u={headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await v.post(t,s,u).then(i=>{const d=i.data.data;return d.forEach(f=>{f.outputs.data.date=e}),d}).catch(i=>{var d,f;if(((d=i.response)==null?void 0:d.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(f=i.response)==null?void 0:f.data),[]})}async function we(t,r){const a=t.links.find(e=>e.rel==="example"&&e.title==="evalscript");if(a)return a;for(const e of W(t,r)){const n=v.get(e).then(o=>o.data.links.find(c=>c.rel==="example"&&c.title==="evalscript"));if(n)return n}}async function ke({links:t,jsonformSchema:r,jsonformValue:a,selectedStac:e,enableCompare:n=!1}){const o=t.find(i=>i.rel==="service"&&i.endpoint==="veda");if(!o)return;const c=o==null?void 0:o.href,l=T(r),s=JSON.parse(a[l]),u=await Se(e,n?G.value:H.value);return await Promise.all(u.map(({endpoint:i,datetime:d})=>v.post(c+`?url=${i}`,{type:"Feature",properties:{},geometry:s}).then(f=>{const p=f.data.properties.statistics;return p.date=d,p}).catch(f=>console.error("[eodash] Error while fetching data from veda endpoint:",f))))}async function Se(t,r){const a=t.links.filter(s=>s.rel=="child"),e=[];a.length?e.push(...await Promise.all(a.map(s=>v.get($(s.href,r)).then(u=>u.data)))):e.push(t);const n=[];for(const s of e){const u=Y(s.links);let i=s.links.filter(d=>d.rel=="item");n.push(...i.map(d=>({endpoint:d.cog_href,datetime:d[u]})))}n.sort((s,u)=>new Date(s.datetime).getTime()-new Date(u.datetime).getTime());const o=50;if(n.length<=o)return n;const c=n.length,l=[];for(let s=0;s<o;s++){const u=Math.floor(s*(c-1)/(o-1));l.push(n[u])}return l}const xe=Ce([ve,ke]);function Ce(t){return async r=>{for(const a of t){const e=await a(r);if(N.debug("Custom endpoint data:",e,"for callback:",a.name,"inputs:",r),!(!e||!e.length||e.some(o=>!o)))return e}return null}}async function Ie({selectedStac:t,jsonformEl:r,jsonformSchema:a,chartSpec:e,isProcessed:n,processResults:o,loading:c,isPolling:l,enableCompare:s}){var d,f;const u=s?!!U.value:!!K.value;let i=null;if((d=t.value)!=null&&d["eodash:jsonform"]&&(i=await v.get(t.value["eodash:jsonform"]).then(p=>p.data)),!i&&u){a.value=null;return}Pe({loading:c,isProcessed:n,chartSpec:e,jsonformSchema:a,isPolling:l,processResults:o}),await((f=r.value)==null?void 0:f.editor.destroy()),i&&(s&&(i=X(i)),a.value=i)}async function _e({loading:t,selectedStac:r,jsonformEl:a,jsonformSchema:e,chartSpec:n,chartData:o,isPolling:c,processResults:l,mapElement:s,jobs:u}){var i,d,f,p,g,h,m,k,I,_,O;if(!(!a.value||!e.value||!r.value)){N.debug("Processing..."),t.value=!0;try{const w=(d=(i=r.value)==null?void 0:i.links)==null?void 0:d.filter(y=>y.rel==="service"),F=T(e.value),S=(f=a.value)==null?void 0:f.value;Z(S,e.value);const R=S[F],B=(p=r.value)==null?void 0:p["eodash:vegadefinition"],q=((g=r.value)==null?void 0:g.id)??"";[n.value,o.value]=await ae({links:w,jsonformValue:{...S??{}},jsonformSchema:e.value,enableCompare:(s==null?void 0:s.id)==="compare",selectedStac:r.value,specUrl:B,isPolling:c,jobs:u,customEndpointsHandler:xe}),Object.keys(o.value??{}).length&&l.value.push(o.value),(k=(m=(h=n.value)==null?void 0:h.data)==null?void 0:m.values)!=null&&k.length&&l.value.push((I=n.value)==null?void 0:I.data.values),n.value&&!("background"in n.value)&&(n.value.background="transparent"),await de(w,S,(s==null?void 0:s.id)==="compare");const C=await ue({isPolling:c,links:w,jsonformValue:{...S??{}},jsonformSchema:e.value,selectedStac:r.value,enableCompare:(s==null?void 0:s.id)==="compare",layerId:q,origBbox:R,jobs:u,customLayersHandler:he,projection:(_=r.value["eodash:mapProjection"])==null?void 0:_.name});if(C.length)for(const y of C)y.type==="WebGLTile"&&((O=y.source)==null?void 0:O.type)==="GeoTIFF"?l.value.push(...y.source.sources??[]):y.source&&"url"in y.source&&l.value.push(y.source.url);Q(s,C),t.value=!1}catch(w){throw console.error("[eodash] Error while running process:",w),t.value=!1,w}}}function Pe({loading:t,isProcessed:r,chartSpec:a,jsonformSchema:e,processResults:n,isPolling:o}){t.value=!1,r.value=!1,o.value=!1,a.value=null,n.value=[],e.value=null}const Oe=t=>{var n,o,c,l,s,u;const r=(n=t.target)==null?void 0:n.spec;if(!r||!((c=(o=t.detail)==null?void 0:o.item)!=null&&c.datum)||!((s=(l=t.detail)==null?void 0:l.item)!=null&&s.datum.datum))return;const a=Object.keys(r.encoding??{}).find(i=>{var d;return((d=r.encoding)==null?void 0:d[i].type)==="temporal"});if(!a)return;const e=(u=r.encoding)==null?void 0:u[a].field;if(e)try{const i=t.detail.item;let d="";i.datum&&i.datum.datum?d=i.datum.datum[e]:d=i.datum[e];const f=new Date(d);z.value=f.toISOString()}catch(i){console.warn("[eodash] Error while setting datetime from eox-chart:",i)}},Ae=()=>{var a,e;x.value||(x.value=new URLSearchParams(window.location.search).get("indicator")??"");const t=J(),r=(a=t.stac)==null?void 0:a.find(n=>A(n)===x.value);if(t.loadSelectedSTAC(r==null?void 0:r.href),U.value)if(P.value){const n=(e=t.stac)==null?void 0:e.find(o=>A(o)===P.value);t.loadSelectedCompareSTAC(n==null?void 0:n.href).catch(o=>{console.error("[eodash] Error loading compare STAC:",o)})}else t.resetSelectedCompareSTAC()};export{_e as h,Ie as i,Ae as l,Oe as o};
