import{d as W,a0 as g,U as Y,$ as I,a as F,a1 as Q,l as L,a2 as X,a3 as Z,j as O,G as ee,E as P,H,a4 as te,a5 as ne,a6 as j,a7 as re,g as ae}from"./eo-dash.ZiFJLFR2.js";import{g as U,e as oe,s as B,c as M,p as se,a as ie}from"./async-B_arT0e1.Bv4RXz1K.js";function le(n,t,r){if(!n)return;const e=n.filter(s=>s.rel==="service"&&s.type==="image/png"),a=[];for(const s of e)a.push({type:"Image",properties:{id:s.id+"_process",title:"Results "+s.id},source:{type:"ImageStatic",imageExtent:r,url:P.render(s.href,{...t??{}})}});return a}async function ce(n,t,r){if(!n)return;const e=[],a=n.filter(i=>i.rel==="service"&&i.type==="application/geo+json");if(a.length===0)return e;let s=null;for(const i of a){"eox:flatstyle"in(i??{})&&(s=await g.get(i["eox:flatstyle"]).then(c=>c.data));let o,l;if(s){const c=te(r??"",s);o=c.layerConfig,l=c.style}const d={type:"Vector",source:{type:"Vector",url:P.render(i.href,{...t??{}}),format:"GeoJSON"},properties:{id:i.id+"_process",title:"Results "+r,...o&&{...o}},...l&&{style:l}};e.push(d)}return e}async function ue({links:n,jsonformValue:t,specUrl:r,customEndpointsHandler:e,jsonformSchema:a,selectedStac:s,isPolling:i}){if(!r||!n)return[null,null];const o=await g.get(r).then(u=>u.data);if(!o.data)return console.error("[eodash] Make sure the Vega spec definition has a data property"),[null,null];const l={},[d,c]=B(n,"service",void 0),f=e&&t&&await e({jsonformSchema:a,jsonformValue:t,links:c,selectedStac:s,isPolling:i});if(f&&f.length)return o.data.values=f,[o,l];const p=d.filter(u=>u.rel==="service");e:for(const u of p??[])switch(u.type){case void 0:continue;case"application/json":await de(o,{url:u.href,jsonformValue:t,link:u,flatstyleUrl:u["eox:flatstyle"]});break e;case"text/csv":await fe(o,{url:u.href,jsonformValue:t,flatstyleUrl:u["eox:flatstyle"]});break e}return[o,l]}async function de(n,{url:t,jsonformValue:r,link:e,flatstyleUrl:a}){if(n.data){if(e.method=="GET"){const s=await q(t,r,a);n.data.values=await g.get(s).then(i=>i.data)}else if(e.method=="POST"){if(!e.body)return console.error("[eodash] Inline data POST request requires a body template"),n;const s=await g.get(e.body,{responseType:"text"}).then(o=>o.data),i=JSON.parse(P.render(s,{...r??{}}));n.data.values=await g.post(t,i).then(o=>o.data)}return n}}async function fe(n,{url:t,jsonformValue:r,flatstyleUrl:e}){if(!n.data){console.error("[eodash] Make sure the Vega spec definition has a data property");return}const a=await q(t,r,e);return n.data.url=a,n}async function q(n,t,r){let e={};return r&&(e=await g.get(r).then(a=>a.data)),P.render(n,{...t??{},...e})}async function pe({links:n,jsonformValue:t,layerId:r,isPolling:e,projection:a,selectedStac:s,jsonformSchema:i,customEndpointsHandler:o}){if(!n)return;const[l,d]=B(n,"service","image/tiff"),c=o&&t&&await o({jsonformValue:t,links:d,selectedStac:s,isPolling:e,jsonformSchema:i});if(c&&c.length)return c;if(!l.length)return;let f=[],p="";for(const h of l??[])f.push(P.render(h.href,{...t??{}}));return l.map(h=>M(h,r,f,a,p))}async function he(n,t){const r=n.find(a=>a.rel==="service"&&a.type=="application/json; profile=collection"&&a.endpoint==="STAC");if(!r)return;let e=P.render(r.href,{...t??{}});H.value&&(H.value=!1),await F().loadSelectedSTAC(e,!0)}async function ge({links:n,jsonformValue:t,isPolling:r,selectedStac:e}){var s;if(!r)return;const a=n.filter(i=>i.rel==="service"&&i.endpoint==="eoxhub_workspaces");for(const i of a){const o=await g.get(i.body,{responseType:"text"}).then(d=>d.data),l=JSON.parse(P.render(o,{...t??{}}));try{const d=await g.post(i.href,l,{headers:{"Content-Type":"application/json"}}),c=JSON.parse(localStorage.getItem(I.value)||"[]");c.push(d.headers.location),localStorage.setItem(I.value,JSON.stringify(c));const{processId:f,urls:p}=await se({processUrl:d.headers.location,isPolling:r}).then(u=>{const h=u==null?void 0:u.urls;return h!=null&&h.length?{processId:u==null?void 0:u.id,urls:h}:{processId:"",urls:[]}}).catch(u=>(u instanceof Error?console.error("Polling failed:",u.message):console.error("Unknown error occurred during polling:",u),{processId:"",urls:[]}));return p.length?await M(i,(e==null?void 0:e.id)??"",p,((s=e==null?void 0:e["eodash:mapProjection"])==null?void 0:s.name)??void 0,f):void 0}catch(d){d instanceof Error?console.error("Error sending POST request:",d.message):console.error("Unknown error occurred:",d)}}}const ve=ye([ge]);function ye(n){return async t=>await Promise.all(n.map(r=>r(t))).then(r=>r.filter(e=>e&&me(e)))}function me(n){var t;return n&&n.source&&n.source.type==="GeoTIFF"&&((t=n.source.sources)==null?void 0:t.length)}async function be({links:n,jsonformValue:t,jsonformSchema:r,selectedStac:e}){const a=n.find(u=>u.rel==="service"&&u.endpoint==="sentinelhub");if(!a)return;const s=await Ee(e);if(!s){console.error("[eodash] evalscript link for sentinel hub not found in indicator",s);return}if(!a)return;const i=a.href,o=U(r),l=t[o],f=await we("414401d7-91f3-4a59-bbd4-117abf7f1bce","RaM>F4o,opW-i{4zV~I4]j|a13Y~@3,,+KdVUh3E");if(!f){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const p=ie(e.extent.temporal.interval[0],[t.start_date,t.end_date],t.distribution);return await Promise.all(p.map(([u,h])=>xe({url:i,bearer:f,bbox:l,from:h,to:u,exampleLink:s}).catch(C=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",C)))).then(u=>u.flat().map(h=>h.outputs.data))}async function we(n,t){const r=sessionStorage.getItem("sentinelhub_token"),e=sessionStorage.getItem("sentinelhub_token_time"),a=Date.now()-Number(e)<3600*1e3;if(r&&a)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),r;const s=await ke(n,t);if(s)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",s),s}async function ke(n,t){const r="https://services.sentinel-hub.com/oauth/token",e={"Content-Type":"application/x-www-form-urlencoded"},a=new URLSearchParams({client_id:n,client_secret:t,response_type:"token",grant_type:"client_credentials"});return await g.post(r,a,{headers:e}).then(s=>s.data.access_token)}async function xe({url:n,bearer:t,bbox:r,from:e,to:a,timeout:s=2e4,exampleLink:i}){if(!i){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!e||!a||new Date(e)>new Date(a)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",e,a);return}const o=await g.get(i.href,{responseType:"text"}).then(c=>c.data);if(!o||o.error){console.error("[eodash] Error (sentinelhub): evalscript not found",o);return}const l={input:{bounds:{bbox:r},data:[{dataFilter:{},type:i.dataId}]},aggregation:{evalscript:o,timeRange:{from:e,to:a},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},d={headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:s};return await g.post(n,l,d).then(c=>{const f=c.data.data;return f.forEach(p=>{p.outputs.data.date=e}),f}).catch(c=>{var f,p;if(((f=c.response)==null?void 0:f.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(p=c.response)==null?void 0:p.data),[]})}async function Ee(n){const t=n.links.find(r=>r.rel==="example"&&r.title==="evalscript");if(t)return t;for(const r of ne(n,j.value)){const e=g.get(r).then(a=>a.data.links.find(s=>s.rel==="example"&&s.title==="evalscript"));if(e)return e}}async function Te({links:n,jsonformSchema:t,jsonformValue:r,selectedStac:e}){const a=n.find(d=>d.rel==="service"&&d.endpoint==="veda");if(!a)return;const s=a==null?void 0:a.href,i=U(t),o=JSON.parse(r[i]),l=await Pe(e);return await Promise.all(l.map(({endpoint:d,datetime:c})=>g.post(s+`?url=${d}`,{type:"Feature",properties:{},geometry:o}).then(f=>{const p=f.data.properties.statistics;return p.date=c,p}).catch(f=>console.error("[eodash] Error while fetching data from veda endpoint:",f))))}async function Pe(n){const t=n.links.filter(o=>o.rel=="child"),r=[];t.length?r.push(...await Promise.all(t.map(o=>g.get(re(o.href,j.value)).then(l=>l.data)))):r.push(n);const e=[];for(const o of r){const l=ae(o.links);let d=o.links.filter(c=>c.rel=="item");e.push(...d.map(c=>({endpoint:c.cog_href,datetime:c[l]})))}e.sort((o,l)=>new Date(o.datetime).getTime()-new Date(l.datetime).getTime());const a=50;if(e.length<=a)return e;const s=e.length,i=[];for(let o=0;o<a;o++){const l=Math.floor(o*(s-1)/(a-1));i.push(e[l])}return i}const Ce=Se([be,Te]);function Se(n){return async t=>{for(const r of n){const e=await r(t);if(L.debug("Custom endpoint data:",e,"for callback:",r.name,"inputs:",t),!(!e||!e.length||e.some(s=>!s)))return e}return null}}async function Le({selectedStac:n,jsonformEl:t,jsonformSchema:r,chartSpec:e,isProcessed:a,processResults:s,loading:i,isPolling:o}){var d;let l=null;if(n.value["eodash:jsonform"]&&(l=await g.get(n.value["eodash:jsonform"]).then(c=>c.data)),!l&&Y.value){r.value=null;return}Ie({loading:i,isProcessed:a,chartSpec:e,jsonformSchema:r,isPolling:o,processResults:s}),await((d=t.value)==null?void 0:d.editor.destroy()),l&&(r.value=l)}async function Ue({loading:n,selectedStac:t,jsonformEl:r,jsonformSchema:e,chartSpec:a,chartData:s,isPolling:i,processResults:o}){var l,d,c,f,p,u,h,C,_,D,G,N;if(!(!r.value||!e.value||!t.value)){L.debug("Processing..."),n.value=!0;try{const k=(d=(l=t.value)==null?void 0:l.links)==null?void 0:d.filter(y=>y.rel==="service"),z=U(e.value),T=(c=r.value)==null?void 0:c.value;oe(T,e.value);const K=T[z],$=(f=t.value)==null?void 0:f["eodash:vegadefinition"],V=((p=t.value)==null?void 0:p.id)??"";[a.value,s.value]=await ue({links:k,jsonformValue:{...T??{}},jsonformSchema:e.value,selectedStac:t.value,specUrl:$,isPolling:i,customEndpointsHandler:Ce}),Object.keys(s.value??{}).length&&o.value.push(s.value),(C=(h=(u=a.value)==null?void 0:u.data)==null?void 0:h.values)!=null&&C.length&&o.value.push((_=a.value)==null?void 0:_.data.values),a.value&&!("background"in a.value)&&(a.value.background="transparent"),await he(k,T);const x=await pe({links:k,jsonformValue:T,layerId:V,isPolling:i,projection:((G=(D=t.value)==null?void 0:D["eodash:mapProjection"])==null?void 0:G.name)??null,jsonformSchema:e.value,selectedStac:t.value,customEndpointsHandler:ve});x==null||x.forEach(y=>{var m,E,v;y&&((m=y.source)!=null&&m.sources.length)&&o.value.push(...((v=(E=y.source)==null?void 0:E.sources)==null?void 0:v.map(S=>S.url))??[])});const b=await ce(k,T,V);b!=null&&b.length&&o.value.push(...b.map(y=>{var m;return(m=y.source)==null?void 0:m.url}));const w=le(k,T,K);if(w!=null&&w.length&&o.value.push(...w.map(y=>{var m;return(m=y.source)==null?void 0:m.url})),L.debug("rendered layers after processing:",x,b,w),x!=null&&x.length||b!=null&&b.length||w!=null&&w.length){const y=[...x??[],...b??[],...w??[]];let m=[...X()],E=m.find(v=>{var S;return(S=v.properties)==null?void 0:S.id.includes("AnalysisGroup")});if(!E)return;for(const v of y)E.layers.find(R=>{var J,A;return((J=R.properties)==null?void 0:J.id)===((A=v.properties)==null?void 0:A.id)})?E.layers=Z(E.layers,((N=v.properties)==null?void 0:N.id)??"",[v]):E.layers.unshift(v);if(O.value){const v=[...m];ee("process:updated",O.value,v),O.value.layers=v}}n.value=!1}catch(k){throw console.error("[eodash] Error while running process:",k),n.value=!1,k}}}function Ie({loading:n,isProcessed:t,chartSpec:r,jsonformSchema:e,processResults:a,isPolling:s}){n.value=!1,t.value=!1,s.value=!1,r.value=null,a.value=[],e.value=null}const De=n=>{var a,s;const t=(a=n.target)==null?void 0:a.spec;if(!t)return;const r=Object.keys(t.encoding??{}).find(i=>{var o;return((o=t.encoding)==null?void 0:o[i].type)==="temporal"});if(!r)return;const e=(s=t.encoding)==null?void 0:s[r].field;if(e)try{const i=n.detail.item,o=new Date(i.datum.datum[e]);W.value=o.toISOString()}catch(i){console.warn("[eodash] Error while setting datetime from eox-chart:",i)}},Ge=()=>{var r;I.value||(I.value=new URLSearchParams(window.location.search).get("indicator")??"");const n=F(),t=(r=n.stac)==null?void 0:r.find(e=>Q(e)===I.value);n.loadSelectedSTAC(t==null?void 0:t.href)};export{Ue as h,Le as i,Ge as l,De as o};
