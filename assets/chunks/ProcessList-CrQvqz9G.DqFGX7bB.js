import{a as B,B as R,V as v,a2 as E,a3 as U,a4 as $,U as I,Y as J,a5 as _,W as g,a6 as N,a7 as F,a8 as G,a9 as M,aa as V,l as W,X as z,i as O,ab as A,ac as H,ad as K,ae as X,af as Y}from"./eo-dash.B4ldaK6n.js";import{g as q}from"./utils.C66ckBg2.js";import{T as x}from"./index-DK9iXmC3.qDobwdhy.js";import{p as Q,an as Z,c as m,o as b,b as j,e as S,k as u,w as ee,j as d,F as te,B as se,t as P,au as k,G as f}from"./framework.Tnsi0AUz.js";import"./commonjsHelpers.BosuxZz1.js";import"./index.BSpBAx16.js";import"./VTooltip-BH-BhRWa.D_5XwOn_.js";import"./VOverlay-DCj2zXLP.Lh9Bs8iJ.js";import"./forwardRefs-cVCka8GZ.Bc4N9g5D.js";import"./transition-Bq0cRCOJ.DHZ8nUFZ.js";function Oe(e){return Object.keys((e==null?void 0:e.properties)??{}).find(o=>(e==null?void 0:e.properties[o].format)==="bounding-box")}function ae(e){return Object.keys((e==null?void 0:e.properties)??{}).filter(o=>(e==null?void 0:e.properties[o].type)==="geojson")}function Pe(e,o){const a=ae(o);for(const t of a)e[t]&&(q(o==null?void 0:o.properties[t])?e[t]=e[t].features.map(s=>JSON.stringify(s.geometry)):e[t]=JSON.stringify(e[t].geometry))}async function oe(e,o,a,t,s){let r=null;"eox:flatstyle"in(e??{})&&(r=await I.get(e["eox:flatstyle"]).then(l=>l.data));let i,n;if(r){const l=J(o??"",r);i=l.layerConfig,n=l.style}a=a.sort();const c=a.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!n,sources:a.map(l=>({url:l}))},properties:{id:o+"_geotiff_process"+s,title:"Results "+o,...i&&{layerConfig:i},layerControlToolsExpand:!0},...n&&{style:n}}:void 0;return t&&c&&(c.source.projection=t),c}const re=(e,o)=>{if(!o)return;let a=o;if(typeof o=="object"){o=JSON.stringify(o);const s=new Blob([o],{type:"text"});a=URL.createObjectURL(s)}const t=document.createElement("a");confirm(`Would you like to download ${e}?`)&&(t.href=a,t.download=e,t.click()),URL.revokeObjectURL(a),t.remove()};function Ce(e,o,a){let t="",s="";[t,s]=o??["",""];const[r,i]=e??["",""];try{if(t&&s?(t=new Date(t),s=new Date(s)):(t=new Date(r),s=new Date(i)),(t<new Date(r)||t>new Date(i))&&(console.warn("[eodash] warn: start date is outside of the collection temporal extent and will be clamped",`
provided start date:${t.toISOString()}`,`
collection start date:${r}`),t=new Date(r)),(s>new Date(i)||s<new Date(r))&&(console.warn("[eodash] warn: end date is outside of the collection temporal extent and will be clamped",`
provided end date:${s.toISOString()}`,`
collection end date:${i}`),s=new Date(i)),t>s)return console.error("[eodash] Error: start date is greater than end date",t,s),[]}catch(p){return console.error("[eodash] Invalid date:",p.message),[]}const n=t.toISOString(),c=s.toISOString();if(!n||!c)return[];const l=[];let h=new Date(c);const C=new Date(n),y=24*60*60*1e3,L=a==="daily"?y:a==="weekly"?y*7:a==="monthly"?y*30:a==="yearly"?y*365:y;for(;h>=C&&l.length<31;)l.push(new Date(h)),h.setTime(h.getTime()-L);const T=[];for(let p=0;p<l.length-1;p++)T.push([l[p].toISOString(),l[p+1].toISOString()]);return T}function Le(e,o,a){if(!e)return[[],[]];const t=[],s=[];for(const r of e){const i=r.rel===o,n=a?r.type===a:!0;i&&n&&(r.endpoint?s.push(r):t.push(r))}return[t,s]}const w=Q([]);async function Be({processUrl:e,isPolling:o,pollInterval:a=1e4,maxRetries:t=560}){let s=0;for(o.value=!0,setTimeout(()=>{D(w,g)},500);s<t&&o.value;){try{const r=new Date().getTime(),n=(await _.get(`${e}?t=${r}`)).data;if(n.status==="successful"){console.log("Process completed successfully. Fetching result item...");const c=n.links[1].href;if(!c)throw new Error("Result links not found in the process report.");const l=await _.get(c);return console.log("Result file fetched successfully:",l.data),l.data}if(n.status==="failed")throw o.value=!1,new Error("Process failed.",n);console.log(`Status: ${n.status}. Retrying in ${a/1e3} seconds...`)}catch(r){r instanceof Error?console.error("Error while polling process status:",r.message):console.error("Unknown error occurred:",r)}await new Promise(r=>setTimeout(r,a)),s++}if(!o.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function D(e,o){const a=JSON.parse(localStorage.getItem(o.value)||"[]"),t=await Promise.all(a.map(s=>fetch(s).then(r=>r.json())));t.sort((s,r)=>new Date(r.job_start_datetime).getTime()-new Date(s.job_start_datetime).getTime()),e.value=t}const ne=async e=>{const a=JSON.parse(localStorage.getItem(g.value)||"[]").filter(t=>!t.includes(e.jobID));localStorage.setItem(g.value,JSON.stringify(a)),D(w,g)},ie=async(e,o)=>{const a=[];await fetch(e.links[1].href).then(t=>t.json()).then(t=>{a.push(...t.urls)}),a.forEach(t=>{if(!t)return;let s="";typeof t=="string"?(s=t.includes("/")?t.split("/").pop()??"":t,s=s.includes("?")?s.split("?")[0]:s):s=(o==null?void 0:o.id)+"_process_results.json",re(s,t)})},le=async(e,o)=>{const a=[];await _.get(e.links[1].href).then(t=>a.push(t.data)),await ce({selectedStac:o,results:a,jobId:e.jobID})};async function ce({selectedStac:e,results:o,jobId:a}){var r;const t=e==null?void 0:e.links.filter(i=>i.rel==="service"&&i.type==="image/tiff"),s=await oe(t==null?void 0:t[0],(e==null?void 0:e.id)??"",o==null?void 0:o[0].urls,((r=e==null?void 0:e["eodash:mapProjection"])==null?void 0:r.name)??null,a);if(W.debug("rendered layers after loading previous process:",s),s){const i=[...s?[s]:[]];let n=[...z()],c=n.find(l=>l.properties.id.includes("AnalysisGroup"));c==null||c.layers.push(...i),O.value&&(O.value.layers=[...n])}}const de=F({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...X(),...K(),...H(),...A()},"VTable"),ue=N()({name:"VTable",props:de(),setup(e,o){let{slots:a,emit:t}=o;const{themeClasses:s}=G(e),{densityClasses:r}=M(e);return V(()=>f(e.tag,{class:["v-table",{"v-table--fixed-height":!!e.height,"v-table--fixed-header":e.fixedHeader,"v-table--fixed-footer":e.fixedFooter,"v-table--has-top":!!a.top,"v-table--has-bottom":!!a.bottom,"v-table--hover":e.hover},s.value,r.value,e.class],style:e.style},{default:()=>{var i,n,c;return[(i=a.top)==null?void 0:i.call(a),a.default?f("div",{class:"v-table__wrapper",style:{height:Y(e.height)}},[f("table",null,[a.default()])]):(n=a.wrapper)==null?void 0:n.call(a),(c=a.bottom)==null?void 0:c.call(a)]}})),{}}}),pe={style:{padding:"0px"}},fe={style:{padding:"0px"}},ye={style:{padding:"0px"}},ge={__name:"ProcessList",setup(e){const{selectedStac:o}=Z(B());return R(()=>D(w,g)),(a,t)=>(b(),m("div",null,[u(w).length?(b(),j(ue,{key:0,density:"compact",style:{"background-color":"transparent"}},{default:ee(()=>[t[0]||(t[0]=d("thead",null,[d("tr",null,[d("th",{class:"text-left"},"Executed on"),d("th",{class:"text-left"},"Status"),d("th",{class:"text-left"}),d("th",{class:"text-left"}),d("th",{class:"text-left"})])],-1)),d("tbody",null,[(b(!0),m(te,null,se(u(w),s=>(b(),m("tr",{key:s.date},[d("td",null,P(new Date(s.job_start_datetime).toISOString().slice(0,16)),1),d("td",null,P(s.status),1),d("td",pe,[k(f(v,{disabled:s.status!=="successful",color:"primary",onClick:r=>u(le)(s,u(o)),icon:[u(E)],variant:"text"},null,8,["disabled","onClick","icon"]),[[x,"Load results to map"]])]),d("td",fe,[k(f(v,{disabled:s.status!=="successful",color:"primary",onClick:r=>u(ie)(s,u(o)),icon:[u(U)],variant:"text"},null,8,["disabled","onClick","icon"]),[[x,"Download results"]])]),d("td",ye,[k(f(v,{color:"#ff5252",onClick:r=>u(ne)(s),icon:[u($)],variant:"text"},null,8,["onClick","icon"]),[[x,"Remove job"]])])]))),128))])]),_:1})):S("v-if",!0)]))}},Re=Object.freeze(Object.defineProperty({__proto__:null,default:ge},Symbol.toStringTag,{value:"Module"}));export{Re as P,ge as _,Ce as a,oe as c,re as d,Pe as e,Oe as g,w as j,Be as p,Le as s,D as u};
