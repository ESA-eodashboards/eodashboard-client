import{q as b,s as G,a as I,k as te,j as ae,d as U,f as V,l as N,r as ie,t as le,o as ne,n as ue,h as ce,v as pe,w as D,x as q,E as H}from"./eo-dash.oprsXpnJ.js";import{p as O,ao as R,h as A,v as $,c as ye,o as ve,j as z,N as Z,k as W,x as E,q as fe}from"./framework.fuI4SACR.js";import"./commonjsHelpers.BosuxZz1.js";const K=async(e,a,n)=>{N.debug("Creating layers config",e,a,n);const r=[],t={type:"Group",properties:{id:"AnalysisGroup",title:"Data Layers",layerControlExpand:!0},layers:[]};for(const i of a){let y;n?y=await i.createLayersJson(new Date(n)):y=await i.createLayersJson(),y.forEach(l=>{l.properties.layerControlExpand=!0,l.properties.layerControlToolsExpand=!0}),t.layers.push(...y)}r.push(t);const u=await H.getIndicatorLayers(e),d=H.getObservationPointsLayer(a);d&&t.layers.unshift(d);const c={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},s=u.filter(i=>i.properties.group==="baselayer");if(s.length){let i=0,y=0;for(let l=0;l<s.length;l++){const f=s[l];"visible"in f.properties||(f.properties.visible=!1),f.properties.visible&&(i++,y=l)}i===0&&(s[0].properties.visible=!0),i>0&&s.forEach((l,f)=>{f!==y?l.properties.visible=!1:l.properties.visible=!0}),c.layers.push(...s),c.layers.forEach(l=>{l.properties.layerControlExclusive=!0})}else c.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});c.layers.length&&r.push(c);const g={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},p=u.filter(i=>i.properties.group==="overlay");return p.length&&(g.layers.push(...p),r.unshift(g)),r};let J=null;const de=(e,a)=>{const n=r=>{var c;const t=r.map,u=(c=e.value)==null?void 0:c.lonLatCenter,d=t==null?void 0:t.getView().getZoom();u&&!Number.isNaN(u[0])&&!Number.isNaN(u[1])&&!Number.isNaN(d)&&(a.value=[u[0],u[1],d])};$(()=>{var r,t;(t=(r=e.value)==null?void 0:r.map)==null||t.on("moveend",n)}),E(()=>{var r,t;(t=(r=e.value)==null?void 0:r.map)==null||t.un("moveend",n)})},Q=(e,a,n,r,t,u,d)=>{N.debug("InitMap",e.value,a.value,n.values,r.value);const c=fe([a,r],async([s,g],[p,i])=>{var y,l,f,P,_,T,h,x,k,v,L,C,m,j,F,S;if(s){N.debug("Selected Indicator watch triggered",s,g),((y=e==null?void 0:e.value)==null?void 0:y.id)==="main"&&J!==null&&((l=e==null?void 0:e.value)==null||l.map.setView(J),J=null);let w=[];const ee=(s==null?void 0:s.id)===(p==null?void 0:p.id)&&g!==i,{selectedCompareStac:oe}=G(I());if(((f=e==null?void 0:e.value)==null?void 0:f.id)==="main"?await pe(s):oe.value!==null&&(J=((P=e==null?void 0:e.value)==null?void 0:P.map.getView())??null,e.value.sync=u.value),ee){w=await K(s,n,g),N.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(w))),t.value=w,D(((_=e.value)==null?void 0:_.id)==="compare"?"compareTime:updated":"time:updated",e.value,w);return}w=await K(s,n,r.value);let M=null;const B=(h=(T=s==null?void 0:s.extent)==null?void 0:T.temporal)==null?void 0:h.interval;if(B&&B.length>0&&B[0].length>1&&(M=new Date(B[0][1]),N.debug("Indicator load: found stac extent, setting time to latest value",M)),M!==null&&M.toISOString()!==r.value&&!q.value&&(r.value=M.toISOString()),d&&((x=e==null?void 0:e.value)==null?void 0:x.id)==="main"&&(k=s.extent)!=null&&k.spatial.bbox&&!(q.value&&((v=b.value)!=null&&v[0])&&((L=b.value)!=null&&L[1]))){const o=(C=s.extent)==null?void 0:C.spatial.bbox[0],re=[(o==null?void 0:o[0])>-180?o==null?void 0:o[0]:-180,(o==null?void 0:o[1])>-90?o==null?void 0:o[1]:-90,(o==null?void 0:o[2])<180?o==null?void 0:o[2]:180,(o==null?void 0:o[3])<90?o==null?void 0:o[3]:90],se=(F=e.value)==null?void 0:F.transformExtent(re,"EPSG:4326",(j=(m=e.value)==null?void 0:m.map)==null?void 0:j.getView().getProjection());e.value.zoomExtent=se}N.debug("Assigned layers",JSON.parse(JSON.stringify(w))),t.value=w,await D(((S=e.value)==null?void 0:S.id)==="compare"?"compareLayers:updated":"layers:updated",e.value,t.value)}},{immediate:!0});E(()=>{c()})},X=(e,a)=>{ie(async(n,r)=>{if(n.includes("compare"))return;const t=[];for(const u of e)t.push(...await u.getToolTipProperties());a.value=t,N.debug("Updated tooltip properties",a.value)})};function ge(e){return 3*e*e-2*e*e*e}const he=[".enabled"],xe=[".center",".zoom",".layers"],Ce=[".propertyTransform"],we=[".layers"],be=[".propertyTransform"];var Y;const _e={__name:"index",props:{enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>{var e,a;return[((e=b.value)==null?void 0:e[0])??15,((a=b.value)==null?void 0:a[1])??48]}},zoom:{type:Number,default:((Y=b.value)==null?void 0:Y[2])??4},zoomToExtent:{type:Boolean,default:!0}},setup(e){var T;const a=e,n=O([]),r=O([]),t={Attribution:{collapsible:!0}},u=R(a.center),d=R(((T=b.value)==null?void 0:T[2])??a.zoom),c=O([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),s=O([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),g={duration:1200,easing:ge},p=O(null),i=O(null),{selectedCompareStac:y}=G(I()),l=A(()=>a.enableCompare&&y.value?"":"first");de(p,b),$(()=>{const{selectedCompareStac:h,selectedStac:x}=G(I());te.value=p.value,a.enableCompare&&(ae.value=i.value),a.enableCompare&&(Q(i,h,ce,U,s,p,!1),X(V,r)),Q(p,x,V,U,c,i,a.zoomToExtent)}),X(V,n);const f=A(()=>({visibility:n.value.length?"visible":"hidden"})),P=A(()=>({visibility:r.value.length?"visible":"hidden"})),_=h=>{const x=h==="main"?n:r,k=h=="main"?ne:ue;return v=>{const L=JSON.parse(le.render(JSON.stringify(x.value),{...k.value??{}})),C=L==null?void 0:L.find(m=>m.id===v.key);if(C)return typeof v.value=="object"&&(v.value=JSON.stringify(v.value)),isNaN(Number(v.value))||(v.value=Number(v.value).toFixed(4).toString()),{key:C.title||C.id,value:v.value+" "+(C.appendix||"")}}};return(h,x)=>(ve(),ye("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":l.value},[z("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:p,id:"main",".animationOptions":g,".center":W(u),".zoom":W(d),".layers":c.value,".controls":t},[z("eox-map-tooltip",{style:Z(f.value),".propertyTransform":_("main")},null,44,Ce)],40,xe),z("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:i,".layers":s.value},[z("eox-map-tooltip",{style:Z(P.value),".propertyTransform":_("compare")},null,44,be)],40,we)],40,he))}};export{_e as default};
