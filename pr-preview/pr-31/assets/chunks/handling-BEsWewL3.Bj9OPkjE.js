import{d as z,aV as S,a as J,aW as D,ag as N,aX as T,af as K,aY as y,l as G,t as w,x as E,aZ as M,a_ as H,a$ as F,b0 as W,g as $}from"./eo-dash.E_vsmdGi.js";import{u as Q,g as L,e as Y,a as X,s as I,c as Z,p as j,b as ee,d as U,f as te,h as ne}from"./async-qaVB0xA7.BnAjP3uQ.js";import{t as ae}from"./item.koN_VtZd.js";async function re({links:e,jsonformValue:a,specUrl:r,customEndpointsHandler:t,jsonformSchema:n,selectedStac:o,isPolling:u,jobs:l,enableCompare:s=!1}){if(!r||!e)return[null,null];const c=await y.get(r).then(h=>h.data),i={},[d,f]=I(e,"service",void 0),p=t&&a&&await t({jsonformSchema:n,jsonformValue:a,links:f,selectedStac:o,isPolling:u,jobs:l,enableCompare:s});if(p&&p.length)return c.data.values=p,[c,i];const g=d.filter(h=>h.rel==="service");try{e:for(const h of g??[])switch(h.type){case void 0:continue;case"application/json":await oe(c,{url:h.href,jsonformValue:a,link:h,flatstyleUrl:h["eox:flatstyle"],jsonformSchema:n});break e;case"text/csv":await se(c,{url:h.href,jsonformValue:a,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[c,i]}async function oe(e,{url:a,jsonformValue:r,link:t,flatstyleUrl:n,jsonformSchema:o}){var u;if(e.data){if(t.method=="GET"){const l=(u=o==null?void 0:o.options)==null?void 0:u.multiQuery,s=Object.keys(r??{}).filter(i=>Array.isArray(l)?l.includes(i):l===i);if(s.length>0&&r){const i=[];for(const d of s)if(Array.isArray(r[d]))for(const f of r[d]){const p=await C(a,{...r,[d]:f},n);i.push(await y.get(p).then(g=>g.data))}else{const f=await C(a,r,n);i.push(await y.get(f).then(p=>p.data))}return e.data.values=i.flat(),e}const c=await C(a,r,n);e.data.values=await y.get(c).then(i=>i.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const l=await y.get(t.body,{responseType:"text"}).then(c=>c.data),s=JSON.parse(w.render(l,{...r??{}}));e.data.values=await y.post(a,s).then(c=>c.data)}return e}}async function se(e,{url:a,jsonformValue:r,flatstyleUrl:t}){if(!e.data)return;const n=await C(a,r,t);return e.data.url=n,e}async function C(e,a,r){let t={};return r&&(t=await y.get(r).then(n=>n.data)),w.render(e,{...a??{},...t})}async function ie({links:e,jsonformValue:a,layerId:r,projection:t}){if(!e)return;const[n,o]=I(e,"service","image/tiff");if(!n.length)return;let u=[],l="";for(const c of n??[])u.push(w.render(c.href,{...a??{}}));return await Promise.all(n.map(c=>Z(c,r,u,t,l))).then(c=>c.filter(i=>!!i))}function ce(e,a,r){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),n=[];for(const o of t)n.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:r,url:w.render(o.href,{...a??{}})}});return n}async function le(e,a,r){if(!e)return;const t=[],n=e.filter(u=>u.rel==="service"&&u.type==="application/geo+json");if(!n.length)return t;let o=null;for(const u of n){"eox:flatstyle"in(u??{})&&(o=await y.get(u["eox:flatstyle"]).then(i=>i.data));let l,s;if(o){const i=M(r??"",o);l=i.layerConfig,s=i.style}const c={type:"Vector",source:{type:"Vector",url:w.render(u.href,{...a??{}}),format:"GeoJSON"},properties:{id:u.id+"_process",title:"Results "+r,...l&&{...l}},...s&&{style:s}};t.push(c)}return t}async function ue({links:e,jsonformValue:a,layerId:r,projection:t,origBbox:n,isPolling:o,selectedStac:u,jsonformSchema:l,jobs:s,customLayersHandler:c,enableCompare:i=!1}){if(!e)return[];const d=[],[f,p]=I(e,"service",void 0);if(c&&a&&u&&l&&p.length>0){const k=await c({jsonformValue:a,links:p,selectedStac:u,isPolling:o,jsonformSchema:l,jobs:s,enableCompare:i});k.length&&d.push(...k)}const g=await le(f,a,r),h=ce(f,a,n),b=await ie({links:f,jsonformValue:a,layerId:r,projection:t});return d.push(...g??[],...h??[],...b??[]),d}async function de(e,a,r=!1){const t=e.find(l=>l.rel==="service"&&l.type=="application/json; profile=collection"&&l.endpoint==="STAC");if(!t)return;let n=w.render(t.href,{...a??{}});E.value&&(E.value=!1);const o=J();await(r?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(n,!0)}async function fe({links:e,jsonformValue:a,isPolling:r,selectedStac:t,jobs:n,enableCompare:o=!1}){if(!r)return;const u=e.filter(s=>s.rel==="service"&&s.endpoint==="eoxhub_workspaces"),l=[];for(const s of u){const c=await y.get(s.body,{responseType:"text"}).then(f=>f.data),i=JSON.parse(w.render(c,{...a??{}})),d=o?T:S;try{const f=await y.post(s.href,i,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(d.value)||"[]");p.push(f.headers.location),localStorage.setItem(d.value,JSON.stringify(p));const g=await j({jobs:n,processUrl:f.headers.location,isPolling:r,enableCompare:o}).then(h=>ee(h)).catch(h=>(h instanceof Error?console.error("Polling failed:",h.message):console.error("Unknown error occurred during polling:",h),[]));await U(n,d.value),l.push(...await te(g,s,t))}catch(f){await U(n,d.value),f instanceof Error?console.error("Error sending POST request:",f.message):console.error("Unknown error occurred:",f)}}return l}const he=pe([fe]);function pe(e){return async a=>await Promise.all(e.map(r=>r(a))).then(r=>{const t=[];for(const n of r)t.push(...(n==null?void 0:n.filter(ge))??[]);return t})}function ge(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function ye({links:e,jsonformValue:a,jsonformSchema:r,selectedStac:t,enableCompare:n=!1}){const o=e.find(g=>g.rel==="service"&&g.endpoint==="sentinelhub");if(!o)return;const u=await me(t,n?H.value:F.value);if(!u){console.error("[eodash] evalscript link for sentinel hub not found in indicator",u);return}if(!o)return;const l=o.href,s=L(r),c=a[s],f=await ve("414401d7-91f3-4a59-bbd4-117abf7f1bce","RaM>F4o,opW-i{4zV~I4]j|a13Y~@3,,+KdVUh3E");if(!f){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const p=ne(t.extent.temporal.interval[0],[a.start_date,a.end_date],a.distribution);return await Promise.all(p.map(([g,h])=>be({url:l,bearer:f,bbox:c,from:h,to:g,exampleLink:u}).catch(b=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",b)))).then(g=>g.flat().map(h=>h.outputs.data))}async function ve(e,a){const r=sessionStorage.getItem("sentinelhub_token"),t=sessionStorage.getItem("sentinelhub_token_time"),n=Date.now()-Number(t)<3600*1e3;if(r&&n)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),r;const o=await we(e,a);if(o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",o),o}async function we(e,a){const r="https://services.sentinel-hub.com/oauth/token",t={"Content-Type":"application/x-www-form-urlencoded"},n=new URLSearchParams({client_id:e,client_secret:a,response_type:"token",grant_type:"client_credentials"});return await y.post(r,n,{headers:t}).then(o=>o.data.access_token)}async function be({url:e,bearer:a,bbox:r,from:t,to:n,timeout:o=2e4,exampleLink:u}){if(!u){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!n||new Date(t)>new Date(n)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,n);return}const l=await y.get(u.href,{responseType:"text"}).then(i=>i.data);if(!l||l.error){console.error("[eodash] Error (sentinelhub): evalscript not found",l);return}const s={input:{bounds:{bbox:r},data:[{dataFilter:{},type:u.dataId}]},aggregation:{evalscript:l,timeRange:{from:t,to:n},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},c={headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await y.post(e,s,c).then(i=>{const d=i.data.data;return d.forEach(f=>{f.outputs.data.date=t}),d}).catch(i=>{var d,f;if(((d=i.response)==null?void 0:d.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(f=i.response)==null?void 0:f.data),[]})}async function me(e,a){const r=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(r)return r;for(const t of W(e,a)){const n=y.get(t).then(o=>o.data.links.find(u=>u.rel==="example"&&u.title==="evalscript"));if(n)return n}}async function ke({links:e,jsonformSchema:a,jsonformValue:r,selectedStac:t,enableCompare:n=!1}){const o=e.find(i=>i.rel==="service"&&i.endpoint==="veda");if(!o)return;const u=o==null?void 0:o.href,l=L(a),s=JSON.parse(r[l]),c=await xe(t,n?H.value:F.value);return await Promise.all(c.map(({endpoint:i,datetime:d})=>y.post(u+`?url=${i}`,{type:"Feature",properties:{},geometry:s}).then(f=>{const p=f.data.properties.statistics;return p.date=d,p}).catch(f=>console.error("[eodash] Error while fetching data from veda endpoint:",f))))}async function xe(e,a){const r=e.links.filter(s=>s.rel=="child"),t=[];r.length?t.push(...await Promise.all(r.map(s=>y.get(ae(s.href,a)).then(c=>c.data)))):t.push(e);const n=[];for(const s of t){const c=$(s.links);let i=s.links.filter(d=>d.rel=="item");n.push(...i.map(d=>({endpoint:d.cog_href,datetime:d[c]})))}n.sort((s,c)=>new Date(s.datetime).getTime()-new Date(c.datetime).getTime());const o=50;if(n.length<=o)return n;const u=n.length,l=[];for(let s=0;s<o;s++){const c=Math.floor(s*(u-1)/(o-1));l.push(n[c])}return l}const Se=Ce([ye,ke]);function Ce(e){return async a=>{for(const r of e){const t=await r(a);if(G.debug("Custom endpoint data:",t,"for callback:",r.name,"inputs:",a),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function _e({selectedStac:e,jsonformEl:a,jsonformSchema:r,chartSpec:t,isProcessed:n,processResults:o,loading:u,isPolling:l,enableCompare:s}){var d,f;const c=s?!!N.value:!!K.value;let i=null;if((d=e.value)!=null&&d["eodash:jsonform"]&&(i=await y.get(e.value["eodash:jsonform"]).then(p=>p.data)),!i&&c){r.value=null;return}Pe({loading:u,isProcessed:n,chartSpec:t,jsonformSchema:r,isPolling:l,processResults:o}),await((f=a.value)==null?void 0:f.editor.destroy()),i&&(s&&(i=Q(i)),r.value=i)}async function Oe({loading:e,selectedStac:a,jsonformEl:r,jsonformSchema:t,chartSpec:n,chartData:o,isPolling:u,processResults:l,mapElement:s,jobs:c}){var i,d,f,p,g,h,b,k,_,O,A;if(!(!r.value||!t.value||!a.value)){G.debug("Processing..."),e.value=!0;try{const m=(d=(i=a.value)==null?void 0:i.links)==null?void 0:d.filter(v=>v.rel==="service"),R=L(t.value),x=(f=r.value)==null?void 0:f.value;Y(x,t.value);const B=x[R],V=(p=a.value)==null?void 0:p["eodash:vegadefinition"],q=((g=a.value)==null?void 0:g.id)??"";[n.value,o.value]=await re({links:m,jsonformValue:{...x??{}},jsonformSchema:t.value,enableCompare:(s==null?void 0:s.id)==="compare",selectedStac:a.value,specUrl:V,isPolling:u,jobs:c,customEndpointsHandler:Se}),Object.keys(o.value??{}).length&&l.value.push(o.value),(k=(b=(h=n.value)==null?void 0:h.data)==null?void 0:b.values)!=null&&k.length&&l.value.push((_=n.value)==null?void 0:_.data.values),n.value&&!("background"in n.value)&&(n.value.background="transparent"),await de(m,x,(s==null?void 0:s.id)==="compare");const P=await ue({isPolling:u,links:m,jsonformValue:{...x??{}},jsonformSchema:t.value,selectedStac:a.value,enableCompare:(s==null?void 0:s.id)==="compare",layerId:q,origBbox:B,jobs:c,customLayersHandler:he,projection:(O=a.value["eodash:mapProjection"])==null?void 0:O.name});if(P.length)for(const v of P)v.type==="WebGLTile"&&((A=v.source)==null?void 0:A.type)==="GeoTIFF"?l.value.push(...v.source.sources??[]):v.source&&"url"in v.source&&l.value.push(v.source.url);X(s,P),e.value=!1}catch(m){throw console.error("[eodash] Error while running process:",m),e.value=!1,m}}}function Pe({loading:e,isProcessed:a,chartSpec:r,jsonformSchema:t,processResults:n,isPolling:o}){e.value=!1,a.value=!1,o.value=!1,r.value=null,n.value=[],t.value=null}const Ae=e=>{var n,o,u,l,s,c;const a=(n=e.target)==null?void 0:n.spec;if(!a||!((u=(o=e.detail)==null?void 0:o.item)!=null&&u.datum)||!((s=(l=e.detail)==null?void 0:l.item)!=null&&s.datum.datum))return;const r=Object.keys(a.encoding??{}).find(i=>{var d;return((d=a.encoding)==null?void 0:d[i].type)==="temporal"});if(!r)return;const t=(c=a.encoding)==null?void 0:c[r].field;if(t)try{const i=e.detail.item;let d="";i.datum&&i.datum.datum?d=i.datum.datum[t]:d=i.datum[t];const f=new Date(d);z.value=f.toISOString()}catch(i){console.warn("[eodash] Error while setting datetime from eox-chart:",i)}},De=()=>{var r,t;S.value||(S.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=J(),a=(r=e.stac)==null?void 0:r.find(n=>D(n)===S.value);if(e.loadSelectedSTAC(a==null?void 0:a.href),N.value)if(T.value){const n=(t=e.stac)==null?void 0:t.find(o=>D(o)===T.value);e.loadSelectedCompareSTAC(n==null?void 0:n.href).catch(o=>{console.error("[eodash] Error loading compare STAC:",o)})}else e.resetSelectedCompareSTAC()};export{Oe as h,_e as i,De as l,Ae as o};
