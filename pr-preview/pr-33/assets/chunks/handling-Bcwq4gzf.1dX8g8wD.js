import{d as z,aH as x,a as N,aI as E,aJ as G,aK as L,aL as Q,aM as y,l as H,aN as w,a0 as U,aO as V,aP as q,aQ as F,aR as W,aS as $,aT as Y,g as X}from"./eo-dash.D-GAmhH8.js";import{u as Z,g as I,e as j,a as ee,s as _,c as te,p as ae,b as ne,d as J,f as re,h as oe}from"./async-D43Yx0SO.B_n-KJOQ.js";import{t as T}from"./item.koN_VtZd.js";async function se({links:e,jsonformValue:n,specUrl:r,customEndpointsHandler:t,jsonformSchema:a,selectedStac:o,isPolling:d,jobs:u,enableCompare:i=!1}){if(!r||!e)return[null,null];const c=await y.get(r).then(h=>h.data),s={},[l,f]=_(e,"service",void 0),p=t&&n&&await t({jsonformSchema:a,jsonformValue:n,links:f,selectedStac:o,isPolling:d,jobs:u,enableCompare:i});if(p&&p.length)return c.data.values=p,[c,s];const g=l.filter(h=>h.rel==="service");try{e:for(const h of g??[])switch(h.type){case void 0:continue;case"application/json":await ie(c,{url:h.href,jsonformValue:n,link:h,flatstyleUrl:h["eox:flatstyle"],jsonformSchema:a});break e;case"text/csv":await ce(c,{url:h.href,jsonformValue:n,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[c,s]}async function ie(e,{url:n,jsonformValue:r,link:t,flatstyleUrl:a,jsonformSchema:o}){var d;if(e.data){if(t.method=="GET"){const u=(d=o==null?void 0:o.options)==null?void 0:d.multiQuery,i=Object.keys(r??{}).filter(s=>Array.isArray(u)?u.includes(s):u===s);if(i.length>0&&r){const s=[];for(const l of i)if(Array.isArray(r[l]))for(const f of r[l]){const p=await P(n,{...r,[l]:f},a);s.push(await y.get(p).then(g=>g.data))}else{const f=await P(n,r,a);s.push(await y.get(f).then(p=>p.data))}return e.data.values=s.flat(),e}const c=await P(n,r,a);e.data.values=await y.get(c).then(s=>s.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const u=await y.get(t.body,{responseType:"text"}).then(c=>c.data),i=JSON.parse(w.render(u,{...r??{}}));e.data.values=await y.post(n,i).then(c=>c.data)}return e}}async function ce(e,{url:n,jsonformValue:r,flatstyleUrl:t}){if(!e.data)return;const a=await P(n,r,t);return e.data.url=a,e}async function P(e,n,r){let t={};return r&&(t=await y.get(r).then(a=>a.data)),w.render(e,{...n??{},...t})}async function le({links:e,jsonformValue:n,layerId:r,projection:t}){if(!e)return;const[a,o]=_(e,"service","image/tiff");if(!a.length)return;let d=[],u="";for(const c of a??[])d.push(w.render(c.href,{...n??{}}));return await Promise.all(a.map(c=>te(c,r,d,t,u))).then(c=>c.filter(s=>!!s))}function ue(e,n,r){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),a=[];for(const o of t)a.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:r,url:w.render(o.href,{...n??{}})}});return a}async function de(e,n,r){if(!e)return;const t=[],a=e.filter(d=>d.rel==="service"&&d.type==="application/geo+json");if(!a.length)return t;let o=null;for(const d of a){"eox:flatstyle"in(d??{})&&(o=await y.get(d["eox:flatstyle"]).then(s=>s.data));let u,i;if(o){const s=V(r??"",o);u=s.layerConfig,i=s.style}const c={type:"Vector",source:{type:"Vector",url:w.render(d.href,{...n??{}}),format:"GeoJSON"},properties:{id:d.id+"_process",title:"Results "+r,...u&&{...u}},...i&&{style:i}};t.push(c)}return t}async function fe({links:e,jsonformValue:n,layerId:r,projection:t,origBbox:a,isPolling:o,selectedStac:d,jsonformSchema:u,jobs:i,customLayersHandler:c,enableCompare:s=!1}){if(!e)return[];const l=[],[f,p]=_(e,"service",void 0);if(c&&n&&d&&u&&p.length>0){const k=await c({jsonformValue:n,links:p,selectedStac:d,isPolling:o,jsonformSchema:u,jobs:i,enableCompare:s});k.length&&l.push(...k)}const g=await de(f,n,r),h=ue(f,n,a),b=await le({links:f,jsonformValue:n,layerId:r,projection:t});return l.push(...g??[],...h??[],...b??[]),l}async function he(e,n,r=!1){const t=e.find(u=>u.rel==="service"&&u.type=="application/json; profile=collection"&&u.endpoint==="STAC");if(!t)return;let a=w.render(t.href,{...n??{}});U.value&&(U.value=!1);const o=N();await(r?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(a,!0)}async function pe({links:e,jsonformValue:n,isPolling:r,selectedStac:t,jobs:a,enableCompare:o=!1}){if(!r)return;const d=e.filter(i=>i.rel==="service"&&i.endpoint==="eoxhub_workspaces"),u=[];for(const i of d){const c=await y.get(i.body,{responseType:"text"}).then(f=>f.data),s=JSON.parse(w.render(c,{...n??{}})),l=o?L:x;try{const f=await y.post(i.href,s,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(l.value)||"[]");p.push(f.headers.location),localStorage.setItem(l.value,JSON.stringify(p));const g=await ae({jobs:a,processUrl:f.headers.location,isPolling:r,enableCompare:o}).then(h=>ne(h)).catch(h=>(h instanceof Error?console.error("Polling failed:",h.message):console.error("Unknown error occurred during polling:",h),[]));await J(a,l.value),u.push(...await re(g,i,t))}catch(f){await J(a,l.value),f instanceof Error?console.error("Error sending POST request:",f.message):console.error("Unknown error occurred:",f)}}return u}const ge=ye([pe]);function ye(e){return async n=>await Promise.all(e.map(r=>r(n))).then(r=>{const t=[];for(const a of r)t.push(...(a==null?void 0:a.filter(ve))??[]);return t})}function ve(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function we({links:e,jsonformValue:n,jsonformSchema:r,selectedStac:t,enableCompare:a=!1}){const o=e.find(g=>g.rel==="service"&&g.endpoint==="sentinelhub");if(!o)return;const d=await Se(t,a?q.value:F.value);if(!d){console.error("[eodash] evalscript link for sentinel hub not found in indicator",d);return}if(!o)return;const u=o.href,i=I(r),c=n[i],f=await be("414401d7-91f3-4a59-bbd4-117abf7f1bce","RaM>F4o,opW-i{4zV~I4]j|a13Y~@3,,+KdVUh3E");if(!f){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const p=oe(t.extent.temporal.interval[0],[n.start_date,n.end_date],n.distribution);return await Promise.all(p.map(([g,h])=>ke({url:u,bearer:f,bbox:c,from:h,to:g,exampleLink:d}).catch(b=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",b)))).then(g=>g.flat().map(h=>h.outputs.data))}async function be(e,n){const r=sessionStorage.getItem("sentinelhub_token"),t=sessionStorage.getItem("sentinelhub_token_time"),a=Date.now()-Number(t)<3600*1e3;if(r&&a)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),r;const o=await me(e,n);if(o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",o),o}async function me(e,n){const r="https://services.sentinel-hub.com/oauth/token",t={"Content-Type":"application/x-www-form-urlencoded"},a=new URLSearchParams({client_id:e,client_secret:n,response_type:"token",grant_type:"client_credentials"});return await y.post(r,a,{headers:t}).then(o=>o.data.access_token)}async function ke({url:e,bearer:n,bbox:r,from:t,to:a,timeout:o=2e4,exampleLink:d}){if(!d){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!a||new Date(t)>new Date(a)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,a);return}const u=await y.get(d.href,{responseType:"text"}).then(s=>s.data);if(!u||u.error){console.error("[eodash] Error (sentinelhub): evalscript not found",u);return}const i={input:{bounds:{bbox:r},data:[{dataFilter:{},type:d.dataId}]},aggregation:{evalscript:u,timeRange:{from:t,to:a},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},c={headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await y.post(e,i,c).then(s=>{const l=s.data.data;return l.forEach(f=>{f.outputs.data.date=t}),l}).catch(s=>{var l,f;if(((l=s.response)==null?void 0:l.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(f=s.response)==null?void 0:f.data),[]})}async function Se(e,n){const r=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(r)return r;for(const t of W(e,n)){const a=y.get(t).then(o=>o.data.links.find(d=>d.rel==="example"&&d.title==="evalscript"));if(a)return a}}async function xe({links:e,jsonformSchema:n,jsonformValue:r,selectedStac:t,enableCompare:a=!1}){const o=e.find(s=>s.rel==="service"&&s.endpoint==="veda");if(!o)return;const d=o==null?void 0:o.href,u=I(n),i=JSON.parse(r[u]),c=await Pe(t,a?q.value:F.value);return await Promise.all(c.map(({endpoint:s,datetime:l})=>y.post(d+`?url=${s}`,{type:"Feature",properties:{},geometry:i}).then(f=>{const p=f.data.properties.statistics;return p.date=l,p}).catch(f=>console.error("[eodash] Error while fetching data from veda endpoint:",f))))}async function Pe(e,n){const r=e.links.filter(i=>i.rel=="child"),t=[];r.length?t.push(...await Promise.all(r.map(i=>y.get(T(i.href,n)).then(c=>c.data).then(c=>{const s=Object.values(c.assets??{}).find(l=>{var f;return l.type==="application/vnd.apache.parquet"&&((f=l.roles)==null?void 0:f.includes("collection-mirror"))});if(s){const l=T(s.href,T(i.href,n));$(l).then(f=>{c.links.push(...Y(f))})}return c})))):t.push(e);const a=[];for(const i of t){const c=X(i.links),s=i.links.filter(l=>l.rel=="item");a.push(...s.map(l=>({endpoint:l.cog_href,datetime:l[c]})))}a.sort((i,c)=>new Date(i.datetime).getTime()-new Date(c.datetime).getTime());const o=50;if(a.length<=o)return a;const d=a.length,u=[];for(let i=0;i<o;i++){const c=Math.floor(i*(d-1)/(o-1));u.push(a[c])}return u}const Ce=Te([we,xe]);function Te(e){return async n=>{for(const r of e){const t=await r(n);if(H.debug("Custom endpoint data:",t,"for callback:",r.name,"inputs:",n),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function Ae({selectedStac:e,jsonformEl:n,jsonformSchema:r,chartSpec:t,isProcessed:a,processResults:o,loading:d,isPolling:u,enableCompare:i}){var l,f;const c=i?!!G.value:!!Q.value;let s=null;if((l=e.value)!=null&&l["eodash:jsonform"]&&(s=await y.get(e.value["eodash:jsonform"]).then(p=>p.data)),!s&&c){r.value=null;return}Le({loading:d,isProcessed:a,chartSpec:t,jsonformSchema:r,isPolling:u,processResults:o}),await((f=n.value)==null?void 0:f.editor.destroy()),s&&(i&&(s=Z(s)),r.value=s)}async function De({loading:e,selectedStac:n,jsonformEl:r,jsonformSchema:t,chartSpec:a,chartData:o,isPolling:d,processResults:u,mapElement:i,jobs:c}){var s,l,f,p,g,h,b,k,O,A,D;if(!(!r.value||!t.value||!n.value)){H.debug("Processing..."),e.value=!0;try{const m=(l=(s=n.value)==null?void 0:s.links)==null?void 0:l.filter(v=>v.rel==="service"),R=I(t.value),S=(f=r.value)==null?void 0:f.value;j(S,t.value);const B=S[R],K=(p=n.value)==null?void 0:p["eodash:vegadefinition"],M=((g=n.value)==null?void 0:g.id)??"";[a.value,o.value]=await se({links:m,jsonformValue:{...S??{}},jsonformSchema:t.value,enableCompare:(i==null?void 0:i.id)==="compare",selectedStac:n.value,specUrl:K,isPolling:d,jobs:c,customEndpointsHandler:Ce}),Object.keys(o.value??{}).length&&u.value.push(o.value),(k=(b=(h=a.value)==null?void 0:h.data)==null?void 0:b.values)!=null&&k.length&&u.value.push((O=a.value)==null?void 0:O.data.values),a.value&&!("background"in a.value)&&(a.value.background="transparent"),await he(m,S,(i==null?void 0:i.id)==="compare");const C=await fe({isPolling:d,links:m,jsonformValue:{...S??{}},jsonformSchema:t.value,selectedStac:n.value,enableCompare:(i==null?void 0:i.id)==="compare",layerId:M,origBbox:B,jobs:c,customLayersHandler:ge,projection:(A=n.value["eodash:mapProjection"])==null?void 0:A.name});if(C.length)for(const v of C)v.type==="WebGLTile"&&((D=v.source)==null?void 0:D.type)==="GeoTIFF"?u.value.push(...v.source.sources??[]):v.source&&"url"in v.source&&u.value.push(v.source.url);ee(i,C),e.value=!1}catch(m){throw console.error("[eodash] Error while running process:",m),e.value=!1,m}}}function Le({loading:e,isProcessed:n,chartSpec:r,jsonformSchema:t,processResults:a,isPolling:o}){e.value=!1,n.value=!1,o.value=!1,r.value=null,a.value=[],t.value=null}const Ee=e=>{var a,o,d,u,i,c;const n=(a=e.target)==null?void 0:a.spec;if(!n||!((d=(o=e.detail)==null?void 0:o.item)!=null&&d.datum)||!((i=(u=e.detail)==null?void 0:u.item)!=null&&i.datum.datum))return;const r=Object.keys(n.encoding??{}).find(s=>{var l;return((l=n.encoding)==null?void 0:l[s].type)==="temporal"});if(!r)return;const t=(c=n.encoding)==null?void 0:c[r].field;if(t)try{const s=e.detail.item;let l="";s.datum&&s.datum.datum?l=s.datum.datum[t]:l=s.datum[t];const f=new Date(l);z.value=f.toISOString()}catch(s){console.warn("[eodash] Error while setting datetime from eox-chart:",s)}},Ue=()=>{var r,t;x.value||(x.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=N(),n=(r=e.stac)==null?void 0:r.find(a=>E(a)===x.value);if(e.loadSelectedSTAC(n==null?void 0:n.href),G.value)if(L.value){const a=(t=e.stac)==null?void 0:t.find(o=>E(o)===L.value);e.loadSelectedCompareSTAC(a==null?void 0:a.href).catch(o=>{console.error("[eodash] Error loading compare STAC:",o)})}else e.resetSelectedCompareSTAC()};export{De as h,Ae as i,Ue as l,Ee as o};
