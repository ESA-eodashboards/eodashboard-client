import{k as P,a as J,F as D,G as N,H as _,d as W,I as V,q as v,J as $,z as G,A as H,l as q,x as Y,y as X,K as k,L as E,M as Z,N as F,O as R,P as j,Q as ee,R as te,S as ae}from"./eo-dash.DVEacP3I.js";import{u as re,g as ne,a as A,e as oe,b as se,s as O,c as ie,p as ce,d as le,f as U,h as ue,i as de}from"./async-D6Lvv-fT.CaUKf2bp.js";import{t as L}from"./item.Bx-rtsOD.js";async function fe({links:e,jsonformValue:t,specUrl:a,customEndpointsHandler:r,jsonformSchema:o,selectedStac:n,isPolling:c,jobs:u,enableCompare:d=!1}){if(!a||!e)return[null,null];const i=await v.get(a).then(y=>y.data),s={},[f,l]=O(e,"service",void 0),p=r&&t&&await r({jsonformSchema:o,jsonformValue:t,links:l,selectedStac:n,isPolling:c,jobs:u,enableCompare:d});if(p&&p.length)return i.data.values=p,[structuredClone(i),structuredClone(s)];const h=f.filter(y=>y.rel==="service"),g=h.filter(y=>y.type==="application/json");if(g.length>=2){for(const y of g??[])switch(y.type){case void 0:continue;case"application/json":s[y.id]=await v.get(k.render(y.href,{...t??{}})).then(b=>b.data),i.data&&(i.data.values={...i.data&&"values"in i.data&&typeof i.data.values=="object"?i.data.values:{},[y.id]:s[y.id]});break}return[i,s]}try{e:for(const y of h??[])switch(y.type){case void 0:continue;case"application/json":await pe(i,{url:y.href,jsonformValue:t,link:y,flatstyleUrl:y["eox:flatstyle"],jsonformSchema:o});break e;case"text/csv":await he(i,{url:y.href,jsonformValue:t,flatstyleUrl:y["eox:flatstyle"]});break e}}catch(y){console.error("[eodash] Error while injecting Vega data",y)}return[structuredClone(i),structuredClone(s)]}async function pe(e,{url:t,jsonformValue:a,link:r,flatstyleUrl:o,jsonformSchema:n}){var c;if(e.data){if(r.method=="GET"){const u=(c=n==null?void 0:n.options)==null?void 0:c.multiQuery,d=Object.keys(a??{}).filter(s=>Array.isArray(u)?u.includes(s):u===s);if(d.length>0&&a){const s=[];for(const f of d)if(Array.isArray(a[f]))for(const l of a[f]){const p=await I(t,{...a,[f]:l},o);s.push(await v.get(p).then(h=>h.data))}else{const l=await I(t,a,o);s.push(await v.get(l).then(p=>p.data))}return e.data.values=s.flat(),e}const i=await I(t,a,o);e.data.values=await v.get(i).then(s=>s.data)}else if(r.method=="POST"){if(!r.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const u=await v.get(r.body,{responseType:"text"}).then(i=>i.data),d=JSON.parse(k.render(u,{...a??{}}));e.data.values=await v.post(t,d).then(i=>i.data)}return e}}async function he(e,{url:t,jsonformValue:a,flatstyleUrl:r}){if(!e.data)return;const o=await I(t,a,r);return e.data.url=o,e}async function I(e,t,a){let r={};return a&&(r=await v.get(a).then(o=>o.data)),k.render(e,{...t??{},...r})}async function ye({links:e,jsonformValue:t,layerId:a,projection:r}){if(!e)return;const[o]=O(e,"service","image/tiff");if(!o.length)return;let n=[],c="";for(const d of o??[])n.push(k.render(d.href,{...t??{}}));return await Promise.all(o.map(d=>ie(d,a,n,r,c))).then(d=>d.filter(i=>!!i))}function ge(e,t,a){if(!e)return;const r=e.filter(n=>n.rel==="service"&&n.type==="image/png"),o=[];for(const n of r)o.push({type:"Image",properties:{id:n.id+"_process",title:"Results "+n.id},source:{type:"ImageStatic",imageExtent:a,url:k.render(n.href,{...t??{}})}});return o}async function ve(e,t,a){if(!e)return;const r=[],o=e.filter(c=>c.rel==="service"&&c.type==="application/geo+json");if(!o.length)return r;let n=null;for(const c of o){"eox:flatstyle"in(c??{})&&(n=await v.get(c["eox:flatstyle"]).then(s=>s.data));let u,d;if(n){const s=Z(a??"",n);u=s.layerConfig,d=s.style}const i={type:"Vector",source:{type:"Vector",url:k.render(c.href,{...t??{}}),format:"GeoJSON"},properties:{id:c.id+"_process",title:"Results "+a,...u&&{...u}},...d&&{style:d}};r.push(i)}return r}async function we({links:e,jsonformValue:t,layerId:a,projection:r,origBbox:o,isPolling:n,selectedStac:c,jsonformSchema:u,jobs:d,customLayersHandler:i,enableCompare:s=!1}){if(!e)return[];const f=[],[l,p]=O(e,"service",void 0);if(i&&t&&c&&u&&p.length>0){const S=await i({jsonformValue:t,links:p,selectedStac:c,isPolling:n,jsonformSchema:u,jobs:d,enableCompare:s});S.length&&f.push(...S)}const h=await ve(l,t,a),g=ge(l,t,o),y=await ye({links:l,jsonformValue:t,layerId:a,projection:r});return f.push(...h??[],...g??[],...y??[]),f}async function be(e,t,a=!1){const r=e.find(u=>u.rel==="service"&&u.type=="application/json; profile=collection"&&u.endpoint==="STAC");if(!r)return;let o=k.render(r.href,{...t??{}});E.value&&(E.value=!1);const n=J();await(a?n.loadSelectedCompareSTAC:n.loadSelectedSTAC)(o,!0)}async function me({links:e,jsonformValue:t,isPolling:a,selectedStac:r,jobs:o,enableCompare:n=!1}){if(!a)return;const c=e.filter(d=>d.rel==="service"&&d.endpoint==="eoxhub_workspaces"),u=[];for(const d of c){const i=await v.get(d.body,{responseType:"text"}).then(l=>l.data),s=JSON.parse(k.render(i,{...t??{}})),f=n?_:P;try{const l=await v.post(d.href,s,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(f.value)||"[]");p.push(l.headers.location),localStorage.setItem(f.value,JSON.stringify(p));const h=await ce({jobs:o,processUrl:l.headers.location,isPolling:a,enableCompare:n}).then(g=>le(g)).catch(g=>(g instanceof Error?console.error("Polling failed:",g.message):console.error("Unknown error occurred during polling:",g),[]));await U(o,f.value),u.push(...await ue(h,d,r))}catch(l){await U(o,f.value),l instanceof Error?console.error("Error sending POST request:",l.message):console.error("Unknown error occurred:",l)}}return u}const ke=Se([me]);function Se(e){return async t=>await Promise.all(e.map(a=>a(t))).then(a=>{const r=[];for(const o of a)r.push(...(o==null?void 0:o.filter(Ce))??[]);return r})}function Ce(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function Pe({links:e,jsonformValue:t,jsonformSchema:a,selectedStac:r,enableCompare:o=!1}){const n=e.find(h=>h.rel==="service"&&h.endpoint==="sentinelhub");if(!n)return;const c=await Le(r,o?F.value:R.value);if(!c){console.error("[eodash] evalscript link for sentinel hub not found in indicator",c);return}if(!n)return;const u=n.href,d=A(a),i=t[d],l=await Ie("414401d7-91f3-4a59-bbd4-117abf7f1bce","RaM>F4o,opW-i{4zV~I4]j|a13Y~@3,,+KdVUh3E");if(!l){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const p=de(r.extent.temporal.interval[0],[t.start_date,t.end_date],t.distribution);return await Promise.all(p.map(([h,g])=>xe({url:u,bearer:l,bbox:i,from:g,to:h,exampleLink:c}).catch(y=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",y)))).then(h=>h.flat().map(g=>g.outputs.data))}async function Ie(e,t){const a=sessionStorage.getItem("sentinelhub_token"),r=sessionStorage.getItem("sentinelhub_token_time"),o=Date.now()-Number(r)<3600*1e3;if(a&&o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),a;const n=await Te(e,t);if(n)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",n),n}async function Te(e,t){const a="https://services.sentinel-hub.com/oauth/token",r={"Content-Type":"application/x-www-form-urlencoded"},o=new URLSearchParams({client_id:e,client_secret:t,response_type:"token",grant_type:"client_credentials"});return await v.post(a,o,{headers:r}).then(n=>n.data.access_token)}async function xe({url:e,bearer:t,bbox:a,from:r,to:o,timeout:n=2e4,exampleLink:c}){if(!c){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!a){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!r||!o||new Date(r)>new Date(o)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",r,o);return}const u=await v.get(c.href,{responseType:"text"}).then(s=>s.data);if(!u||u.error){console.error("[eodash] Error (sentinelhub): evalscript not found",u);return}const d={input:{bounds:{bbox:a},data:[{dataFilter:{},type:c.dataId}]},aggregation:{evalscript:u,timeRange:{from:r,to:o},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},i={headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:n};return await v.post(e,d,i).then(s=>{const f=s.data.data;return f.forEach(l=>{l.outputs.data.date=r}),f}).catch(s=>{var f,l;if(((f=s.response)==null?void 0:f.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(l=s.response)==null?void 0:l.data),[]})}async function Le(e,t){const a=e.links.find(r=>r.rel==="example"&&r.title==="evalscript");if(a)return a;for(const r of j(e,t)){const o=v.get(r).then(n=>n.data.links.find(c=>c.rel==="example"&&c.title==="evalscript"));if(o)return o}}async function _e({links:e,jsonformSchema:t,jsonformValue:a,selectedStac:r,enableCompare:o=!1}){const n=e.find(s=>s.rel==="service"&&(s.endpoint==="veda"||s.endpoint==="veda_stac"));if(!n)return;const c=n==null?void 0:n.href,u=A(t),d=JSON.parse(a[u]),i=await Ae(r,o?F.value:R.value,n);return await Promise.all(i.map(({endpoint:s,datetime:f})=>{const l=new URL(c),p=n.endpoint==="veda_stac"?"ids":"url";return l.searchParams.set(p,s),v.post(l.toString(),{type:"Feature",properties:{},geometry:d}).then(h=>{const g=h.data.properties.statistics;return g.date=f,g}).catch(h=>console.error("[eodash] Error while fetching data from veda endpoint:",h))}))}async function Ae(e,t,a){const r=e.links.filter(i=>i.rel=="child"),o=[];r.length?o.push(...await Promise.all(r.map(i=>v.get(L(i.href,t)).then(s=>s.data).then(async s=>{const f=Object.values(s.assets??{}).find(l=>{var p;return l.type==="application/vnd.apache.parquet"&&((p=l.roles)==null?void 0:p.includes("collection-mirror"))});if(f){const l=L(f.href,L(i.href,t));await ee(l).then(p=>{s.links.push(...te(p))})}return s})))):o.push(e);const n=[];for(const i of o){const s=ae(i.links),f=i.links.filter(l=>l.rel=="item");n.push(...f.map(l=>({endpoint:a.endpoint==="veda_stac"?l.id:l.cog_href,datetime:l[s]})))}n.sort((i,s)=>new Date(i.datetime).getTime()-new Date(s.datetime).getTime());const c=50;if(n.length<=c)return n;const u=n.length,d=[];for(let i=0;i<c;i++){const s=Math.floor(i*(u-1)/(c-1));d.push(n[s])}return d}const Oe=De([Pe,_e]);function De(e){return async t=>{for(const a of e){const r=await a(t);if(q.debug("Custom endpoint data:",r,"for callback:",a.name,"inputs:",t),!(!r||!r.length||r.some(n=>!n)))return r}return null}}async function He({selectedStac:e,jsonformEl:t,jsonformSchema:a,isProcessed:r,processResults:o,loading:n,isPolling:c,enableCompare:u}){var s,f,l,p,h,g;const d=u?!!N.value:!!V.value;let i=null;if((s=e.value)!=null&&s["eodash:jsonform"]&&(i=await v.get(e.value["eodash:jsonform"]).then(y=>y.data)),!i&&d){a.value=null;return}Ue({loading:n,isProcessed:r,jsonformSchema:a,isPolling:c,processResults:o,enableCompare:u}),await((f=t.value)==null?void 0:f.editor.destroy()),i&&((g=(h=(p=(l=i.properties)==null?void 0:l.feature)==null?void 0:p.options)==null?void 0:h.drawtools)!=null&&g.layerId&&await Ee({jsonformSchema:a,newLayers:await $()}),u&&(i=re(i)),a.value=i)}async function Ee({jsonformSchema:e,newLayers:t}){var o,n,c;const a=e.value;if(!a)return;const r=ne(a);if(r&&t&&((c=(n=(o=a==null?void 0:a.properties[r])==null?void 0:o.options)==null?void 0:n.drawtools)!=null&&c.layerId)){let u=t;t.layers&&Array.isArray(t.layers)&&(u=t.layers);const d=a.properties[r].options.drawtools.layerId.split(";:;")[0];let i=null;const s=f=>{var l,p;if(f){for(const h of f)if(h.layers)s(h);else if((p=(l=h.properties)==null?void 0:l.id)!=null&&p.startsWith(d)){i=h.properties.id;break}}};if(s(u),i)a.properties.feature.options.drawtools.layerId=i,e.value=null,await new Promise(f=>setTimeout(f,0)),e.value=a;else throw new Error(`Could not find matching layer for processing form with id: ${d}`)}}async function qe({loading:e,selectedStac:t,jsonformEl:a,jsonformSchema:r,isPolling:o,processResults:n,mapElement:c,jobs:u}){var i,s,f,l,p,h,g,y,S;if(!a.value||!r.value||!t.value)return;const d=(c==null?void 0:c.id)==="compare";q.debug("Processing..."),e.value=!0;try{const b=(s=(i=t.value)==null?void 0:i.links)==null?void 0:s.filter(m=>m.rel==="service"),z=A(r.value),C=(f=a.value)==null?void 0:f.value;oe(C,r.value);const B=C[z],K=(l=t.value)==null?void 0:l["eodash:vegadefinition"],M=((p=t.value)==null?void 0:p.id)??"",Q=d?G:H,T=d?Y:X;let w=null;[w,T.value]=await fe({links:b,jsonformValue:{...C??{}},jsonformSchema:r.value,enableCompare:d,selectedStac:t.value,specUrl:K,isPolling:o,jobs:u,customEndpointsHandler:Oe}),Object.keys(T.value??{}).length&&n.value.push(T.value),(g=(h=w.data)==null?void 0:h.values)!=null&&g.length&&n.value.push(w==null?void 0:w.data.values),w&&!("background"in w)&&(w.background="transparent"),Q.value=w,await be(b,C,(c==null?void 0:c.id)==="compare");const x=await we({isPolling:o,links:b,jsonformValue:{...C??{}},jsonformSchema:r.value,selectedStac:t.value,enableCompare:(c==null?void 0:c.id)==="compare",layerId:M,origBbox:B,jobs:u,customLayersHandler:ke,projection:(y=t.value["eodash:mapProjection"])==null?void 0:y.name});if(x.length)for(const m of x)m.type==="WebGLTile"&&((S=m.source)==null?void 0:S.type)==="GeoTIFF"?n.value.push(...m.source.sources??[]):m.source&&"url"in m.source&&n.value.push(m.source.url);se(c,x),e.value=!1}catch(b){throw console.error("[eodash] Error while running process:",b),e.value=!1,b}}function Ue({loading:e,isProcessed:t,jsonformSchema:a,processResults:r,isPolling:o,enableCompare:n}){e.value=!1,t.value=!1,o.value=!1;const c=n?G:H;c.value=null,r.value=[],a.value=null}const Fe=e=>{var o,n,c,u,d,i;const t=(o=e.target)==null?void 0:o.spec;if(!t||!((c=(n=e.detail)==null?void 0:n.item)!=null&&c.datum)&&!((d=(u=e.detail)==null?void 0:u.item)!=null&&d.datum.datum))return;const a=Object.keys(t.encoding??{}).find(s=>{var f;return((f=t.encoding)==null?void 0:f[s].type)==="temporal"});if(!a)return;const r=(i=t.encoding)==null?void 0:i[a].field;if(r)try{const s=e.detail.item;let f="";s.datum&&s.datum.datum?f=s.datum.datum[r]:f=s.datum[r];const l=new Date(f);W.value=l.toISOString()}catch(s){console.warn("[eodash] Error while setting datetime from eox-chart:",s)}},Re=()=>{var a,r;P.value||(P.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=J(),t=(a=e.stac)==null?void 0:a.find(o=>D(o)===P.value);if(e.loadSelectedSTAC(t==null?void 0:t.href),N.value)if(_.value){const o=(r=e.stac)==null?void 0:r.find(n=>D(n)===_.value);e.loadSelectedCompareSTAC(o==null?void 0:o.href).catch(n=>{console.error("[eodash] Error loading compare STAC:",n)})}else e.resetSelectedCompareSTAC()};export{qe as h,He as i,Re as l,Fe as o,Ee as u};
